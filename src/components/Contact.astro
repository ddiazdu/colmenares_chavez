---
import emailjs from "@emailjs/browser";
---

<section id="contacto" class="w-full py-16 px-4 bg-cream">
    <div class="max-w-4xl mx-auto">
        <header class="mb-8 text-center">
            <h2 class="text-3xl md:text-4xl font-bold text-darkBrown">
                Contacto
            </h2>
            <p class="mt-2 text-mediumBrown">
                ¿Tienes dudas o quieres agendar una charla? Escríbenos y
                conversemos.
            </p>
        </header>

        <form
            id="contact-form"
            class="bg-white rounded-2xl shadow p-6 space-y-4"
        >
            <label class="block">
                <span class="text-darkBrown text-sm">Nombre</span>
                <input
                    type="text"
                    name="nombre"
                    required
                    placeholder="Tu nombre"
                    class="mt-1 w-full rounded-xl border border-mediumBrown/30 px-3 py-2 outline-none focus:border-yellowLight focus:ring-yellowLight"
                />
            </label>

            <label class="block">
                <span class="text-darkBrown text-sm">Correo</span>
                <input
                    type="email"
                    name="correo"
                    required
                    placeholder="tu@correo.com"
                    class="mt-1 w-full rounded-xl border border-mediumBrown/30 px-3 py-2 outline-none focus:border-yellowLight focus:ring-yellowLight"
                />
            </label>

            <label class="block">
                <span class="text-darkBrown text-sm">Mensaje</span>
                <textarea
                    name="mensaje"
                    required
                    rows="5"
                    placeholder="Cuéntanos en qué te ayudamos"
                    class="mt-1 w-full rounded-xl border border-mediumBrown/30 px-3 py-2 outline-none focus:border-yellowLight focus:ring-yellowLight"
                ></textarea>
            </label>

            <div class="flex flex-col gap-2">
                <button
                    id="send-btn"
                    type="submit"
                    class="w-full md:w-auto inline-flex items-center justify-center gap-2 rounded-xl bg-darkBrown text-white px-5 py-2.5 font-medium hover:bg-mediumBrown transition"
                >
                    Enviar
                </button>

                <!-- Check (centro, aparece al éxito) -->
                <div class="relative h-9 w-full pointer-events-none">
                    <div
                        id="tick"
                        class="absolute left-1/2 -translate-x-1/2 top-0 opacity-0"
                    >
                        <svg
                            viewBox="0 0 24 24"
                            width="28"
                            height="28"
                            aria-hidden="true"
                        >
                            <circle cx="12" cy="12" r="11" fill="#22c55e"
                            ></circle>
                            <path
                                d="M7 12.5l3.2 3.2L17 9.8"
                                fill="none"
                                stroke="#fff"
                                stroke-width="2.2"
                                stroke-linecap="round"
                                stroke-linejoin="round"></path>
                        </svg>
                    </div>
                </div>

                <p id="form-status" class="text-sm mt-1"></p>
            </div>
        </form>
    </div>
</section>

<script>
    import emailjs from "@emailjs/browser";

    const {
        PUBLIC_EMAILJS_KEY: PUBLIC_KEY,
        PUBLIC_EMAILJS_SERVICE: SERVICE_ID,
        PUBLIC_EMAILJS_TEMPLATE_ADMIN: TEMPLATE_ADMIN,
        PUBLIC_EMAILJS_TEMPLATE_AUTOREP: TEMPLATE_AUTOREP,
    } = import.meta.env;

    emailjs.init(PUBLIC_KEY);

    const form = document.getElementById("contact-form")!;
    const statusEl = document.getElementById("form-status")!;
    const btn = document.getElementById("send-btn")! as HTMLButtonElement;
    const tick = document.getElementById("tick")!;

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // UI: enviando
        btn.disabled = true;
        const original = btn.textContent;
        btn.textContent = "Enviando…";
        statusEl.className = "text-sm text-mediumBrown";
        tick.classList.remove("tick-show", "tick-fade");

        const data = new FormData(form);
        const payload = {
            nombre: data.get("nombre"),
            correo: data.get("correo"),
            mensaje: data.get("mensaje"),
        };

        try {
            // 1) correo interno para ti
            await emailjs.send(SERVICE_ID, TEMPLATE_ADMIN, payload);
            // 2) autorespuesta al usuario
            await emailjs.send(SERVICE_ID, TEMPLATE_AUTOREP, payload);

            // éxito: check y mensaje
            tick.classList.add("tick-show");
            statusEl.textContent = "✅ ¡Gracias! Tu mensaje fue enviado.";
            statusEl.className = "text-sm text-green-700";
            form.reset();

            // ocultar mensaje y check a los 2s
            setTimeout(() => {
                statusEl.textContent = "";
                tick.classList.add("tick-fade");
            }, 2000);

            // limpiar anim clases después del fade
            setTimeout(() => {
                tick.classList.remove("tick-show", "tick-fade");
            }, 2600);
        } catch (err) {
            console.error(err);
            statusEl.textContent =
                "❌ No se pudo enviar. Intenta nuevamente o escríbenos por WhatsApp.";
            statusEl.className = "text-sm text-red-700";
        } finally {
            btn.disabled = false;
            btn.textContent = original || "Enviar";
        }
    });
</script>
